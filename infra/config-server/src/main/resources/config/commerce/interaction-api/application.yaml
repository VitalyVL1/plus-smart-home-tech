resilience4j.circuitbreaker:
  configs:
    # Базовая конфигурация по умолчанию - используется как шаблон для других конфигов
    default:
      slidingWindowType: COUNT_BASED        # Тип окна: COUNT_BASED = на основе количества вызовов
      # (альтернатива: TIME_BASED = на основе времени)
      slidingWindowSize: 100                # Размер окна: анализировать последние 100 вызовов
      minimumNumberOfCalls: 10              # Минимальное количество вызовов в окне для принятия решения
      # (если вызовов меньше - CB не срабатывает, избегаем ложных срабатываний)
      permittedNumberOfCallsInHalfOpenState: 3  # Количество тестовых вызовов в HALF_OPEN состоянии
      # (проверяем, восстановился ли сервис)
      automaticTransitionFromOpenToHalfOpenEnabled: true  # Автоматический переход OPEN → HALF_OPEN
      # после waitDurationInOpenState
      writableStackTraceEnabled: false       # Отключаем полные stack traces для ошибок
      # (уменьшаем нагрузку на память и логгирование)

    # Конфигурация "ЧУВСТВИТЕЛЬНАЯ" - для критичных сервисов с низкой толерантностью к ошибкам
    sensitive:
      baseConfig: default                    # Наследуем все настройки из 'default'
      failureRateThreshold: 20               # Порог ошибок: 20% → CB сработает при 20% неудачных вызовов
      # (низкое значение = быстрая реакция на проблемы)
      slowCallRateThreshold: 25              # Порог медленных вызовов: 25%
      # (если 25% вызовов медленные → считаем проблемой)
      slowCallDurationThreshold: 1000        # Вызов считается медленным если > 1000 мс (1 секунда)
      waitDurationInOpenState: 5000          # Время в OPEN состоянии: 5000 мс (5 секунд)
      # (через 5 секунд автоматически переходит в HALF_OPEN)

    # Конфигурация "УМЕРЕННАЯ" - баланс между отзывчивостью и стабильностью
    moderate:
      baseConfig: default                    # Наследуем из 'default'
      failureRateThreshold: 40               # 40% ошибок для срабатывания
      # (менее чувствительный, чем sensitive)
      slowCallRateThreshold: 40              # 40% медленных вызовов
      slowCallDurationThreshold: 2000        # Вызов медленный если > 2000 мс (2 секунды)
      waitDurationInOpenState: 10000         # 10 секунд в OPEN состоянии
      # (даем больше времени на восстановление)

    # Конфигурация "ТОЛЕРАНТНАЯ" - для не критичных сервисов или с плановыми простоями
    tolerant:
      baseConfig: default                    # Наследуем из 'default'
      failureRateThreshold: 50               # 50% ошибок для срабатывания
      # (высокий порог, CB срабатывает редко)
      slowCallRateThreshold: 60              # 60% медленных вызовов
      slowCallDurationThreshold: 5000        # Вызов медленный если > 5000 мс (5 секунд)
      # (разрешаем долгие ответы)
      waitDurationInOpenState: 20000         # 20 секунд в OPEN состоянии
      # (долгое время на восстановление)

  instances:
    # Корзина покупок - критичный сервис, высокая частота запросов
    shopping-cart:
      baseConfig: sensitive                  # Используем чувствительную конфигурацию
      # (быстро реагируем на проблемы)
      slidingWindowSize: 100                 # Анализируем последние 100 вызовов
      # (достаточно для статистики при высокой нагрузке)
      minimumNumberOfCalls: 20               # Нужно минимум 20 вызовов для анализа
        # (больше чем в default, чтобы избежать ложных срабатываний
      #  при небольшой нагрузке)

    # Магазин/каталог - сервис чтения, можно кешировать данные
    shopping-store:
      baseConfig: moderate                   # Умеренная конфигурация
      # (баланс между отзывчивостью и стабильностью)
      slidingWindowType: TIME_BASED          # Временное окно вместо счетного
      # (лучше для сервисов с переменной нагрузкой)
      slidingWindowSize: 60                  # 60 секунд - анализируем вызовы за последнюю минуту
      # (единица: секунды, т.к. TIME_BASED)

    # Склад - критичный для бизнеса, но может быть медленным
    warehouse:
      baseConfig: sensitive                  # Чувствительная конфигурация
      # (надежность важнее скорости)
      slidingWindowSize: 30                  # Анализируем только последние 30 вызовов
        # (малое окно = быстрая реакция на проблемы,
      #  т.к. вызовов к складу обычно меньше)
      minimumNumberOfCalls: 5                # Всего 5 вызовов достаточно для принятия решения
      # (мало вызовов = быстрое срабатывание при проблемах)
      waitDurationInOpenState: 30000         # 30 секунд в OPEN состоянии (переопределяем sensitive)
        # (даем складу больше времени на восстановление,
      #  т.к. восстановление может быть долгим)